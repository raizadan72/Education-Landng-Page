var logEvent;
var onLinkClick;
(function ($) {
    'use strict';
    $(function () {
        logEvent = function (eventType, data, onComplete, onError) {
            var logEventArgs = analytics_client_context['event_base'];
            var clientContext = analytics_client_context['client_context'];
            clientContext['page_info'] = {
                'hostname': window.location.hostname,
                'uri': window.location.pathname,
                'query': window.location.search,
                'referrer': document.referrer
            };

            logEventArgs['events'] = [{
                type: eventType,
                data: data,
                timestamp: new Date().getTime(),
                context: clientContext
            }];

            $.ajax({
                url: '/ws/analytics/0.1/json/Event/Log/',
                method: "POST",
                timeout: 1500,
                data: {
                    arguments: JSON.stringify(logEventArgs)
                },
                complete: onComplete,
                error: onError
            });
        };
		
		if(localStorage.getItem('deviceInfo') == null){
			logEvent('device-info', {
				'cookie-enabed': navigator.cookieEnabled,
				'user-agent-data': navigator.userAgentData,
				'platform': navigator.platform,
				'do-not-track': navigator.doNotTrack
			});
			localStorage.setItem('deviceInfo', new Date().getTime());
		}

        onLinkClick = function (e) {
            var element = $(e.target);
            if (element.attr("href")) {
                e.preventDefault();
                try {
                    logEvent(
                        'link-click',
                        {
                            hostname: window.location.hostname,
                            uri: window.location.pathname,
                            query: window.location.search,
                            element: {
                                href: element.attr('href'),
                                title: element.attr('title') || '',
                                target: element.attr('target') || '',
                                label: element.attr('bi-label') || '',
                                id: element.attr('id') || '',
                                text: element.text()
                            },
                            mouse: {
                                clientX: e.clientX,
                                clientY: e.clientY,
                                offsetX: e.offsetX,
                                offsetY: e.offsetY
                            }
                        },
                        function (data){
                            window.location = element.attr("href");
                        },
                        function (request, status, error) {
                            console.log('Unable to log event ' + error);
                            window.location = element.attr("href");
                        }
                    );
                } catch (e) {
                    console.log('Unable to log event ' + e);
                    window.location = element.attr("href");
                }
            }
        };

        if(window.location.pathname.includes('wp-admin') !== true){
            $('a').click(onLinkClick);

            $('[data-elementor-lightbox]').each(function (el) {
                var element = $(this);
                element.click(function (e) {
                    var lightBoxInfo = JSON.parse(element.attr('data-elementor-lightbox'));
                    if (lightBoxInfo) {
                        logEvent(
                            'lightbox-trigger',
                            lightBoxInfo,
                            null,
                            function (request, status, error) {
                                console.log('Unable to log lightbox event ' + error);
                            }
                        )
                        setTimeout(function () {
                            if (lightBoxInfo.type === 'video') {
                                var videoElement = document.querySelector('.elementor-lightbox video');
                                videoElement.addEventListener('ended', function (e) {
                                    logEvent('video-ended', {
                                        'url': lightBoxInfo.url,
                                        'progress': Math.round(e.target.currentTime),
                                        'duration': Math.round(e.target.duration)
                                    });

                                    var ctaMsg = 'Want to learn more?';
                                    var linkText = 'Click Here';
                                    var linkUrl = '/contact';
                                    console.log(element);
                                    var ctaInfoElement = element.closest('[data-cta-msg]');
                                    if (ctaInfoElement) {
                                        ctaMsg = ctaInfoElement.attr('data-cta-msg') || ctaMsg;
                                        linkText = ctaInfoElement.attr('data-cta-link') || linkText;
                                        linkUrl = ctaInfoElement.attr('data-cta-url') || linkUrl;
                                    }
                                    var el = document.createElement('div');
                                    el.innerHTML = `<div class="video-cta"><h2>${ctaMsg}</h2><a id="cta-button" href="${linkUrl}">${linkText}</a></div>`;
                                    e.target.parentElement.appendChild(el);
                                    $(el).find('a').click(onLinkClick);
                                });
                                videoElement.addEventListener("play", function (e) {
                                    logEvent('video-play', {
                                        'url': lightBoxInfo.url,
                                        'progress': Math.round(e.target.currentTime),
                                        'duration': Math.round(e.target.duration)
                                    });
                                });
                                videoElement.addEventListener("pause", function (e) {
                                    logEvent('video-pause', {
                                        'url': lightBoxInfo.url,
                                        'progress': Math.round(e.target.currentTime),
                                        'duration': Math.round(e.target.duration)
                                    });
                                });
                                videoElement.addEventListener("timeupdate", function (e) {
                                    logEvent('video-scrub', {
                                        'url': lightBoxInfo.url,
                                        'progress': Math.round(e.target.currentTime),
                                        'duration': Math.round(e.target.duration)
                                    });
                                });
                            }
                        }, 1000);
                    }
                });
            });
        }
    });
})(jQuery);
